# Overview

This folder contains files and information around the Printed Circuit Board contained inside the Implantable Pulse Generator (IPG). This PCB was designed for CARSS by Medipace Inc. (https://www.medipaceinc.com/). Editable source files, generated using Altium, can be found in the Source Files folder.

# Design
The purpose of this PCBA is to regulate power, communication, neuromodulation, and biomarker sensing. Individual sections of the PCB are explained below.

## Power Regulation and Transmission
### Power and NFC data transmission
The IPG PCB receives power inductively through a coil resonating between 100 - 300 kHz. Load-Shift Keying (LSK) can be used to transmit data over this inductive link, by selectively de-tuning the load via transistors M501, M514, and M515. Amplitude shift keyed signals can also be received by this PCB by sampling the rectified signal. After rectifying and protecting against overvoltage the inductively transmitted power signal is converted to a battery charging voltage VCHRG_RAIL at 5V and up to 600mA by a LTC3130IUDC-1 buck-boost converter (U503).
![Schematic coil 1](https://github.com/CARSSCenter/Device/assets/124087207/ef10f11f-e385-4414-a927-ce2ece78609a)

![Schematic coil 2](https://github.com/CARSSCenter/Device/assets/124087207/2cd2e186-c4a7-41e0-af02-e9f8b1496d88)


### Battery charging
The 5V generated by U503 feeds into two LTC4065LEDC battery charging ICs (U2 and U4) which can be programmed to one of four charging currents using signals CHG_RATE1 and CHG_RATE2 from the MCU. Each of the two cells has its own independent charging circuit and overvoltage  protection circuit. However, the set charge rate applies to both cells simultaneously.
![Schematic charge controllers and protection](https://github.com/CARSSCenter/Device/assets/124087207/4413e3c5-6e94-455f-9812-e18d07c5f585)


### Digital and analog voltage generation
The buffered battery voltages are used to generate three separate 3.3V rails using three independent AP7354D low dropout regulators. The digital supply, DVDD, supplies power to the MCU and BLE circuitry. The stimulation supply, VDDS, supplies voltage to low-voltage components in the stimulation and impedance sensing circuitry. The analog supply, VDDA, supplies voltage to the ECG and EGG circuits.
![Schematic DVDD Supply](https://github.com/CARSSCenter/Device/assets/124087207/f64806b2-8fb9-4fe3-add8-a6028bd0014d)


### Thermistor interface
Buffer circuitry is included for using a thermistor to monitor the temperature of the PCB during use.
![Schematic thermistor](https://github.com/CARSSCenter/Device/assets/124087207/d248265e-89db-4ccd-aab7-607ae280ac15)


### Magnet Sensor
A magnetic sensor BD020 (U8) and supporting circutry disconnects the battery from the supply voltage generating circuitry in the presence of a magnetic field. It should be noted that charging circuitry is still connected to the batteries when a magnetic field is present. However, as digital enable pins that affect charging rate will be in an undetermined state, and no thermal monitoring circuitry will be available to check the temperature of the PCB or battery during charging, we do not recommend charging this board in the presence of a magnetic field.
[Speculation - ask Victor!]
![Schematic battery and mag switch](https://github.com/CARSSCenter/Device/assets/124087207/14a5a014-28d1-4be4-9a27-b2ebab15788c)


## MCU
Digital processing is accomplished by an STM32U585 MCU (U17) microcontroller. This MCU is connected via SPI to an external FRAM unit CY15B108QN (U9) which adds 8MB of RAM to the system.
![Schematic MCU](https://github.com/CARSSCenter/Device/assets/124087207/7c02ed16-de20-47cb-ac93-a9c6361f55d4)


## Stimulation
Current based stimulation is achieved by first generating an analog voltage between 0 and 3.3V using a DAC80502 digital to analog converter (U301). This voltage is fed in to an op amp based current source which converts it to a produces a current I = V_DAC / 1k with a heardroom of 3.3V. Afterwards, this current is fed into one or more of the four stimulation channels, which multiplies the current by a factor of 25 using a current mirror and reaises the voltage headroom to a value set by potentiometer U13. 
![Schematic stim](https://github.com/CARSSCenter/Device/assets/124087207/22a916fd-4c9a-49e3-98ea-420cca3f6e28)
![Schematic HV](https://github.com/CARSSCenter/Device/assets/124087207/88dd2c94-83ed-400c-89ba-b9c20d6aee52)


## Impedance Sensing
Impedance measurement is accomplished by first sending the voltage produced by stimulation through a 10M / 2M voltage divider, then through a mux and buffer before being shown to ADC pins on the MCU. The inputs to the diff amp can be either one of the four stimulation electrodes or the enclosure ground. 
![Schematic impedance](https://github.com/CARSSCenter/Device/assets/124087207/741542bf-88e8-4bec-b904-b78cb18b7f38)


## ECG and EGG Sensing
Sensing ECG or EEG signal is achieved using a second mux to attach one of the electrodes to one of two AD8233 biopotential filter / amplifiers, tuned to different bandwidths most appropriate for the signal under consideration.
![Schematic ECG EGG](https://github.com/CARSSCenter/Device/assets/124087207/eb8a3393-b68b-46da-acd5-cf169404eb54)


## Bluetooth Low Energy (BLE)
BLE communication uses a secondary dedicated NRF52810 MCU (U91) which communicates with the main MCU through a UART interface. The NRF chip outputs to a 50 Ohm controlled impedance trace which should be connected to an antenna built in to the enclosure.
![Schematic BLE](https://github.com/CARSSCenter/Device/assets/124087207/818ca3ba-6066-4681-904f-89de49034737)


# Status and updates
## 29 June 2023
The first revision of the PCBA has been taped out and assembled; testing is expected to be finished by the end of 2023.
![Test Board rev1](https://github.com/CARSSCenter/Device/assets/124087207/5d264da4-7320-4ac3-8b8e-37be243782f6)

